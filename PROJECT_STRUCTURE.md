# Project Structure & Build Documentation

## Overview
This is an Outlook Add-in project using Webpack for bundling, Office.js from npm package (not CDN), and includes version checking with cache management functionality.

---

## Directory Structure

```
OLRecpTest/
├── .github/
│   └── copilot-instructions.md          # GitHub Copilot configuration
├── .vscode/                              # VS Code workspace settings
├── assets/                               # Static image assets
│   ├── icon-*.png                        # Add-in icons (16, 32, 64, 80, 128)
│   └── logo-filled.png                   # Add-in logo
├── dist/                                 # Build output (generated by webpack)
│   ├── office-js/                        # Office.js library from npm (83.4 MB, 729 files)
│   │   ├── office.js                     # Main Office.js file
│   │   ├── office.debug.js               # Debug version
│   │   ├── MicrosoftAjax.js             # Dependency loaded by Office.js
│   │   ├── [locale folders]/             # Localization files (200+ languages)
│   │   └── [other dependencies]          # Telemetry, web auth, etc.
│   ├── assets/                           # Copied image assets
│   ├── taskpane.html                     # Compiled task pane HTML
│   ├── taskpane.js                       # Bundled task pane JavaScript
│   ├── taskpane.js.map                   # Source map for debugging
│   ├── commands.html                     # Compiled commands HTML
│   ├── commands.js                       # Bundled commands JavaScript
│   ├── polyfill.js                       # Core-js and regenerator polyfills
│   ├── manifest.xml                      # Add-in manifest (copied)
│   └── version.json                      # Remote version info (copied)
├── public/                               # Static files to copy
│   ├── office-js/                        # Office.js files (generated by pre-build)
│   └── version.json                      # Remote version configuration
├── src/                                  # Source code
│   ├── commands/
│   │   ├── office-js/                    # Office.js copy for webpack resolution
│   │   ├── commands.html                 # Commands page template
│   │   └── commands.js                   # Commands functionality
│   ├── taskpane/
│   │   ├── office-js/                    # Office.js copy for webpack resolution
│   │   ├── taskpane.html                 # Task pane template
│   │   ├── taskpane.js                   # Task pane logic
│   │   └── taskpane.css                  # Task pane styles
│   └── version-config.js                 # Version checking utilities
├── copy-office-js.js                     # Pre-build script to copy Office.js
├── manifest.xml                          # Add-in manifest (source)
├── package.json                          # npm dependencies and scripts
├── webpack.config.js                     # Webpack configuration
└── babel.config.json                     # Babel transpilation config
```

---

## Key Files Explained

### Configuration Files

#### `package.json`
- **Purpose**: Defines npm dependencies, scripts, and project metadata
- **Key Scripts**:
  - `build:dev`: Runs `copy-office-js.js` then webpack in development mode
  - `build`: Production build with copy-office-js script
  - `start`: Launches webpack-dev-server and sideloads add-in to Outlook
  - `stop`: Stops debugging and uninstalls add-in
  - `clear-cache`: PowerShell script to clear Office cache
- **Dependencies**:
  - `@microsoft/office-js`: Office JavaScript API (npm package)
  - `core-js`: Polyfills for ES6+ features
  - `regenerator-runtime`: Async/await support
- **DevDependencies**:
  - `webpack`, `webpack-cli`, `webpack-dev-server`: Bundler
  - `babel-loader`, `@babel/core`: JavaScript transpilation
  - `html-loader`: HTML processing
  - `css-loader`, `style-loader`: CSS processing
  - `copy-webpack-plugin`: Static file copying
  - `html-webpack-plugin`: HTML generation
  - `office-addin-*`: Microsoft Office add-in development tools

#### `webpack.config.js`
- **Purpose**: Configures webpack bundling process
- **Entry Points**:
  - `polyfill`: Core-js and regenerator-runtime
  - `taskpane`: Task pane JavaScript, HTML, and CSS
  - `commands`: Commands JavaScript
- **Output**:
  - Directory: `dist/`
  - Clean: `true` (removes old files before build)
- **Loaders**:
  - **babel-loader**: Transpiles modern JavaScript to ES5
  - **html-loader**: Processes HTML templates
    - Processes `<img>` tags and `<link>` tags for local CSS
    - EXCLUDES `<script>` tags (allows office.js reference to remain unchanged)
  - **css-loader + style-loader**: Bundles CSS into JavaScript
  - **asset/resource**: Handles images with content hashing
- **Plugins**:
  - **HtmlWebpackPlugin** (2 instances):
    - Generates `taskpane.html` and `commands.html`
    - Injects bundled JavaScript into body
    - Uses inline loader to disable source processing: `!!html-loader?{"sources":false}!`
  - **CopyWebpackPlugin**:
    - Copies assets (icons, logo)
    - Copies public/* (version.json)
    - Copies entire public/office-js directory to dist/office-js
    - Copies and transforms manifest.xml (dev vs prod URLs)
- **Externals**:
  - `@microsoft/office-js`: 'Office' - Prevents bundling, expects global `Office` object
- **Dev Server**:
  - HTTPS enabled (required for Office add-ins)
  - Port: 3000
  - Hot module replacement enabled

#### `babel.config.json`
- **Purpose**: Configures JavaScript transpilation
- **Presets**: `@babel/preset-env` with useBuiltIns: 'usage'
- **Target**: Modern browsers supporting Office add-ins

#### `manifest.xml`
- **Purpose**: Defines add-in capabilities and configuration
- **Key Elements**:
  - `Id`: Unique add-in identifier
  - `Version`: 1.0.0.0
  - `ProviderName`: Contoso
  - `DefaultLocale`: en-US
  - `SourceLocation`: Points to `https://localhost:3000/taskpane.html`
  - `Requirements`: Mailbox 1.1 API
  - `FormSettings`: Task pane configuration
  - `ExtensionPoint`: MessageComposeCommandSurface (ribbon button)

---

## Build Process Flow

### Pre-Build: `copy-office-js.js`

**Purpose**: Copies Office.js and all dependencies from npm package to multiple locations

**Execution**: Runs automatically before every `npm run build:dev` or `npm run build`

**Process**:
1. **Source**: `node_modules/@microsoft/office-js/dist/`
2. **Destinations** (all 3 locations receive full copy):
   - `public/office-js/` → For webpack CopyWebpackPlugin
   - `src/taskpane/office-js/` → For webpack HTML processing resolution
   - `src/commands/office-js/` → For webpack HTML processing resolution

3. **Files Copied**: 
   - 729 files (83.4 MB total)
   - Main files: office.js, office.debug.js
   - Dependencies: MicrosoftAjax.js, telemetry, web auth
   - Localization: 200+ language folders
   - Host-specific files: outlook-*, excel-*, word-*, etc.

**Why Multiple Copies?**
- `public/office-js/`: Used by webpack CopyWebpackPlugin to copy to dist/
- `src/*/office-js/`: Required during webpack build so HTML templates can resolve `./office-js/office.js` reference during processing
- These src copies are NOT bundled (excluded via html-loader config)

---

### Webpack Build Process

#### 1. **Entry Points Processing**

**Polyfill Entry** (`polyfill.js`):
- Bundles: `core-js/stable` + `regenerator-runtime/runtime`
- Output: `dist/polyfill.js` (~1.08 MB)
- Purpose: ES6+ compatibility for older browsers

**Taskpane Entry** (`taskpane.js`):
- Input files:
  - `src/taskpane/taskpane.js`
  - `src/taskpane/taskpane.html` (via entry point)
  - `src/taskpane/taskpane.css` (imported in JS)
- Processing:
  1. JavaScript transpilation via babel-loader
  2. CSS bundling via css-loader → style-loader
  3. Import resolution for `version-config.js`
- Output: 
  - `dist/taskpane.js` (~62.5 KB) - includes bundled CSS
  - `dist/taskpane.js.map` - source map

**Commands Entry** (`commands.js`):
- Input: `src/commands/commands.js`
- Processing: Same as taskpane
- Output: `dist/commands.js` (~25.7 KB)

#### 2. **HTML Processing**

**Template Loading**:
```javascript
template: "!!html-loader?{\"sources\":false}!./src/taskpane/taskpane.html"
```
- `!!` - Disables other configured loaders
- `html-loader?{"sources":false}` - Inline loader with sources disabled
- This prevents html-loader from processing ANY sources in the template

**Why sources:false?**
- Office.js reference `<script src="./office-js/office.js">` must NOT be processed by webpack
- If webpack processes it, it tries to bundle/hash the filename
- Office.js requires exact filename "office.js" or "office.debug.js" (Microsoft validation)

**HTML Generation** (HtmlWebpackPlugin):
1. Loads HTML template
2. Does NOT process script src (sources:false)
3. Injects bundled JavaScript tags in body:
   ```html
   <script defer src="polyfill.js"></script>
   <script defer src="taskpane.js"></script>
   ```
4. Writes to `dist/taskpane.html`

#### 3. **Asset Processing**

**Images**:
- Rule: `/\.(png|jpg|jpeg|gif|ico)$/`
- Type: `asset/resource`
- Output: `dist/assets/[name][ext][query]`
- Content hashing: Disabled for predictable names

**CSS**:
- Rule: `/\.css$/`
- Loaders: `style-loader`, `css-loader`
- Process:
  1. `css-loader`: Resolves @import and url() in CSS
  2. `style-loader`: Injects CSS into DOM at runtime via `<style>` tags
- Result: CSS bundled INTO JavaScript (not separate .css file)

#### 4. **File Copying** (CopyWebpackPlugin)

**Pattern 1 - Assets**:
```javascript
{ from: "assets/*", to: "assets/[name][ext][query]" }
```
- Copies all files from `assets/` to `dist/assets/`
- Preserves original filenames

**Pattern 2 - Public Files**:
```javascript
{ from: "public/*", to: "[name][ext][query]" }
```
- Copies files directly in `public/` to `dist/`
- Currently: `version.json`

**Pattern 3 - Office.js Directory**:
```javascript
{ from: "public/office-js", to: "office-js" }
```
- Recursively copies entire `public/office-js/` to `dist/office-js/`
- Preserves directory structure
- **Critical**: This is why Office.js works - all 729 files copied with exact filenames

**Pattern 4 - Manifest**:
```javascript
{
  from: "manifest*.xml",
  to: "[name][ext]",
  transform(content) {
    // Replaces localhost:3000 with production URL in production builds
  }
}
```

#### 5. **Source Maps**

- **devtool**: `"source-map"`
- Generates `.map` files for debugging
- Maps bundled code back to original source
- Enables breakpoints in original TypeScript/ES6 code

---

## Runtime Loading Sequence

### 1. **Outlook Launches Add-in**
- Outlook reads `manifest.xml`
- Creates iframe pointing to `https://localhost:3000/taskpane.html`

### 2. **HTML Load**
```html
<!-- dist/taskpane.html -->
<script src="./office-js/office.js"></script>  <!-- Loads from dist/office-js/office.js -->
<script defer src="polyfill.js"></script>
<script defer src="taskpane.js"></script>
```

### 3. **Office.js Initialization**
- Browser loads `dist/office-js/office.js` (58 KB)
- Office.js internally loads dependencies from same directory:
  - `MicrosoftAjax.js` (via relative path)
  - `outlook-win32-16.00.js` (host-specific)
  - Locale files (e.g., `en-us/outlook_strings.js`)
  - Telemetry modules
- Office.js validates filename (must be exactly "office.js")
- Creates global `Office` object

### 4. **Application JavaScript Execution**
- `polyfill.js` loads first (ES6+ compatibility)
- `taskpane.js` loads:
  1. Imports version-config.js (bundled inline)
  2. Executes CSS injection via style-loader
  3. Calls `Office.onReady()` to initialize

### 5. **Office.onReady Callback**
```javascript
Office.onReady((info) => {
  if (info.host === Office.HostType.Outlook) {
    clearOfficeCache();      // Clear localStorage/sessionStorage
    checkForUpdates();       // Version check against public/version.json
    // Initialize UI...
  }
});
```

---

## Special Configurations

### Office.js from npm (Not CDN)

**Challenge**: Office.js from npm package requires:
1. Exact filename "office.js" (no content hashing)
2. All dependencies in same directory structure
3. Relative path loading for dependencies

**Solution Implemented**:

1. **Pre-build Copy Script** (`copy-office-js.js`):
   - Copies entire `dist/` folder from npm package
   - Creates identical structure in 3 locations

2. **Webpack html-loader Configuration**:
   ```javascript
   {
     test: /\.html$/,
     use: {
       loader: "html-loader",
       options: {
         sources: {
           list: [
             { tag: "img", attribute: "src", type: "src" },
             { 
               tag: "link", 
               attribute: "href", 
               type: "src",
               filter: (tag, attribute, attributes) => {
                 const href = attributes.href;
                 return href && href.endsWith('.css') && !href.startsWith('http');
               }
             }
             // Script tags EXCLUDED - office.js reference left unchanged
           ]
         }
       }
     }
   }
   ```

3. **HtmlWebpackPlugin with Inline Loader**:
   ```javascript
   new HtmlWebpackPlugin({
     template: "!!html-loader?{\"sources\":false}!./src/taskpane/taskpane.html"
   })
   ```
   - Disables ALL source processing for templates
   - Office.js script tag remains as `./office-js/office.js`

4. **CopyWebpackPlugin**:
   - Copies entire `public/office-js/` to `dist/office-js/`
   - Preserves exact filenames and directory structure

### Version Checking System

**Files**:
- `src/version-config.js`: Version utilities
- `public/version.json`: Remote version info
- Uses localStorage for caching

**Configuration** (`version-config.js`):
```javascript
export const CURRENT_VERSION = '0.0.1';
export const VERSION_CONFIG = {
  REMOTE_VERSION_URL: '/version.json',
  CHECK_INTERVAL_HOURS: 24,
  // ...
};
```

**Process**:
1. On `Office.onReady()`, calls `checkForUpdates()`
2. Fetches `/version.json` from server
3. Compares semantic versions
4. If remote > local, shows update alert with changelog

---

## Development Workflow

### Starting Development
```bash
npm start
```
**Process**:
1. Runs webpack-dev-server on https://localhost:3000
2. Enables debugging for add-in ID
3. Registers add-in with Microsoft 365
4. Launches Outlook desktop
5. Auto-sideloads add-in

### Building for Development
```bash
npm run build:dev
```
**Process**:
1. Executes `copy-office-js.js`
2. Runs webpack in development mode
3. Generates source maps
4. Outputs to `dist/`

### Building for Production
```bash
npm run build
```
**Differences from dev**:
- Minified JavaScript
- Optimized bundles
- manifest.xml URLs transformed to production
- No source maps (optional)

### Stopping/Cleaning
```bash
npm stop                    # Stop debugging & uninstall add-in
npm run clear-cache         # Clear Office cache (PowerShell)
```

---

## Troubleshooting

### Office.js Not Loading
**Symptom**: "MicrosoftAjax.js is not loaded successfully"
**Cause**: Office.js dependencies not found
**Solution**: Ensure `dist/office-js/` contains all 729 files

### CSS Not Applied
**Symptom**: Elements display horizontally, no styling
**Cause**: CSS not imported or loaders missing
**Solution**: 
1. Verify `import './taskpane.css'` in JS
2. Ensure `css-loader` and `style-loader` installed
3. Check webpack config has CSS rule

### Manifest Errors
**Symptom**: Add-in won't sideload
**Cause**: manifest.xml validation failures
**Solution**: Run `npm run validate`

### Build Errors
**Symptom**: "Module not found" during build
**Cause**: Missing dependencies or incorrect paths
**Solution**: 
1. Check `npm install` completed
2. Verify file paths in webpack.config.js
3. Ensure office-js copied to src/*/office-js/

---

## Performance Considerations

### Bundle Sizes
- **polyfill.js**: 1.08 MB (core-js + regenerator)
- **taskpane.js**: ~62 KB (including CSS)
- **commands.js**: ~26 KB
- **office-js directory**: 83.4 MB (729 files)
  - Only office.js (58 KB) loads initially
  - Dependencies load on-demand

### Optimization Strategies
1. **Code Splitting**: Separate polyfills from app code
2. **Tree Shaking**: Unused core-js modules excluded via useBuiltIns
3. **CSS in JS**: Reduces HTTP requests, enables hot reload
4. **Source Maps**: Separate files, not inline (dev only)

### Load Time
- **Initial**: ~100-200ms (HTML + office.js + polyfills)
- **Interactive**: ~300-500ms (app JS + CSS injection)
- **Office.onReady**: ~500-800ms (Office API initialization)

---

## Git Ignore Patterns

**.gitignore**:
```
node_modules/
dist/
.vscode/
*.log
public/office-js/
src/taskpane/office-js/
src/commands/office-js/
```

**Rationale**:
- `dist/`: Build artifacts (regenerated)
- `office-js/`: Generated from npm package (83.4 MB)
- `node_modules/`: npm dependencies (can be restored)
- `.vscode/`: User-specific editor settings

---

## Scripts Reference

| Script | Command | Purpose |
|--------|---------|---------|
| `build` | `node copy-office-js.js && webpack --mode production` | Production build |
| `build:dev` | `node copy-office-js.js && webpack --mode development` | Development build |
| `dev-server` | `webpack serve --mode development` | Start dev server only |
| `start` | `office-addin-debugging start manifest.xml` | Build, serve, and sideload |
| `stop` | `office-addin-debugging stop manifest.xml` | Stop debugging |
| `validate` | `office-addin-manifest validate manifest.xml` | Validate manifest |
| `clear-cache` | `powershell -ExecutionPolicy Bypass -File ...` | Clear Office cache |
| `lint` | `office-addin-lint check` | Check code quality |
| `lint:fix` | `office-addin-lint fix` | Auto-fix lint issues |

---

## Dependencies Tree

```
Project
├── @microsoft/office-js (npm package source)
├── Runtime Dependencies
│   ├── core-js (ES6+ polyfills)
│   └── regenerator-runtime (async/await)
├── Build Tools
│   ├── webpack & webpack-cli
│   ├── webpack-dev-server (HTTPS dev server)
│   └── copy-webpack-plugin (file copying)
├── JavaScript Processing
│   ├── @babel/core & @babel/preset-env
│   └── babel-loader
├── HTML Processing
│   ├── html-loader
│   └── html-webpack-plugin
├── CSS Processing
│   ├── css-loader
│   └── style-loader
├── Office Add-in Tools
│   ├── office-addin-cli
│   ├── office-addin-debugging
│   ├── office-addin-dev-certs (HTTPS)
│   └── office-addin-lint
└── TypeScript Definitions
    ├── @types/office-js
    └── @types/office-runtime
```

---

## Conclusion

This project demonstrates a complete Outlook Add-in using:
- **Office.js from npm** (not CDN) with proper dependency handling
- **Webpack 5** for modern bundling with HMR
- **Babel** for ES6+ transpilation
- **Custom pre-build scripts** for Office.js distribution
- **Version checking** with cache management
- **HTTPS development** with auto-sideloading

The key innovation is the Office.js npm package integration, which requires careful webpack configuration to preserve filenames and directory structure while still benefiting from webpack's bundling capabilities.
